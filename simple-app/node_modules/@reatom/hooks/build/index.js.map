{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["import {\n  action,\n  Action,\n  atom,\n  Atom,\n  AtomCache,\n  AtomState,\n  Ctx,\n  CtxSpy,\n  Fn,\n  throwReatomError,\n  Unsubscribe,\n} from '@reatom/core'\nimport { noop, toAbortError, isAbort, merge } from '@reatom/utils'\n\nexport const getRootCause = (cause: AtomCache): AtomCache =>\n  cause.cause === null ? cause : getRootCause(cause.cause)\n\nexport const isSameCtx = (ctx1: Ctx, ctx2: Ctx) =>\n  getRootCause(ctx1.cause) === getRootCause(ctx2.cause)\n\nexport const addOnConnect = (anAtom: Atom, cb: Fn<[Ctx]>) =>\n  (anAtom.__reatom.connectHooks ??= new Set()).add(cb)\n\nexport const addOnDisconnect = (anAtom: Atom, cb: Fn<[Ctx]>) =>\n  (anAtom.__reatom.disconnectHooks ??= new Set()).add(cb)\n\nexport const addOnUpdate = <T extends Atom>(\n  anAtom: T,\n  cb: Fn<[Ctx, AtomCache<AtomState<T>>]>,\n) => (anAtom.__reatom.updateHooks ??= new Set()).add(cb)\n\nexport const withInit =\n  <T extends Atom>(\n    createState: Fn<[Ctx, T['__reatom']['initState']], AtomState<T>>,\n  ): Fn<[T], T> =>\n  (anAtom) => {\n    const { initState, isAction } = anAtom.__reatom\n\n    throwReatomError(isAction, 'action state is not manageable')\n\n    anAtom.__reatom.initState = (ctx) => createState(ctx, initState)\n\n    return anAtom\n  }\n\nexport const onConnect = (\n  anAtom: Atom,\n  cb: Fn<[Ctx & { controller: AbortController; isConnected(): boolean }]>,\n): Unsubscribe => {\n  const connectHook = (ctx: Ctx) => {\n    const controller = new AbortController()\n    const cleanup = cb(\n      merge(ctx, {\n        // TODO: how to do it more performant\n        cause: merge(\n          ctx.get((read) => read(anAtom.__reatom)!),\n          { controller },\n        ),\n        controller,\n        isConnected: () => isConnected(ctx, anAtom),\n      }),\n    )\n\n    if (cleanup instanceof Promise) {\n      cleanup.catch((error) => {\n        if (!isAbort(error)) throw error\n      })\n    }\n\n    // TODO: abort on `connectHooks.delete`?\n    const cleanupHook = (_ctx: Ctx) => {\n      if (\n        isSameCtx(ctx, _ctx) &&\n        disconnectHooks.delete(cleanupHook) &&\n        connectHooks.has(connectHook)\n      ) {\n        controller.abort(toAbortError(`${anAtom.__reatom.name} disconnect`))\n        typeof cleanup === 'function' && cleanup()\n      }\n    }\n\n    const disconnectHooks = addOnDisconnect(anAtom, cleanupHook)\n  }\n\n  const connectHooks = addOnConnect(anAtom, connectHook)\n\n  return () => connectHooks.delete(connectHook)\n}\n\nexport const onDisconnect = (anAtom: Atom, cb: Fn<[Ctx]>): Unsubscribe =>\n  onConnect(anAtom, (ctx) => () => cb(ctx))\n\n// @ts-expect-error\nconst _onUpdate: {\n  <Params extends any[], Payload>(\n    anAction: Action<Params, Payload> & { deps?: Array<Atom> },\n    cb?: Fn<\n      [\n        Ctx,\n        Payload,\n        AtomCache<AtomState<Action<Params, Payload>>> & { params: Params },\n      ]\n    >,\n  ): Unsubscribe\n  <T>(\n    anAtom: Atom<T> & { deps?: Array<Atom> },\n    cb?: Fn<[Ctx, T, AtomCache<T>]>,\n  ): Unsubscribe\n} = <T>(\n  anAtom: Action<any[], T> | Atom<T>,\n  cb: Fn<[Ctx, T, AtomCache<T>]> = noop,\n) => {\n  const hook = (ctx: Ctx, patch: AtomCache & { params?: unknown[] }) => {\n    let { state } = patch\n    if (anAtom.__reatom.isAction) {\n      if (patch.state.length === 0) return\n      const call = state.at(-1)!\n      state = call.payload\n      patch.params = call.params\n    }\n    cb(ctx, state, patch)\n  }\n\n  const hooks = addOnUpdate(anAtom, hook)\n\n  return () => hooks.delete(hook)\n}\n\nexport const onUpdate: typeof _onUpdate = (anAtom: Atom, cb = noop) =>\n  ((anAtom as Atom & { deps?: Array<Atom> }).deps ?? []).reduce((acc, dep) => {\n    const un = onUpdate(dep, (ctx) => ctx.get(anAtom))\n    return () => {\n      un()\n      acc()\n    }\n  }, _onUpdate(anAtom, cb) as Unsubscribe)\n\n/** @deprecated use the second parameter of `ctx.spy` instead */\n// @ts-ignore\nexport const spyChange: {\n  <Params extends any[], Payload>(\n    ctx: CtxSpy,\n    anAction: Action<Params, Payload>,\n    handler?: Fn<[{ params: Params; payload: Payload }]>,\n  ): boolean\n  <T>(ctx: CtxSpy, anAtom: Atom<T>, handler?: Fn<[T, T?]>): boolean\n} = (ctx: CtxSpy, anAtom: Atom, handler?: Fn) => {\n  let isChanged = false\n  ctx.spy(anAtom, (newState, prevState) => {\n    isChanged = true\n    handler?.(newState, prevState)\n  })\n  return isChanged\n}\n\nexport const controlConnection =\n  <T>(\n    initState = true,\n    name?: string,\n  ): Fn<\n    [Atom<T>],\n    Atom<T> & { toggleConnection: Action<[boolean?], boolean> }\n  > =>\n  (anAtom) => {\n    name ??= `${anAtom.__reatom.name}.controlConnection`\n\n    const isActiveAtom = atom(initState, `${name}._isActiveAtom`)\n\n    return Object.assign(\n      {\n        toggleConnection: action(\n          (ctx, value) => isActiveAtom(ctx, (state) => value ?? !state),\n          `${name}.toggleConnection`,\n        ),\n      },\n      atom(\n        (ctx, state?: any) => (ctx.spy(isActiveAtom) ? ctx.spy(anAtom) : state),\n        name,\n      ),\n    )\n  }\n\nexport const isConnected = (ctx: Ctx, { __reatom: proto }: Atom) =>\n  ctx.get((read) => {\n    const cache = proto.patch ?? read(proto)\n    return !!cache && cache.subs.size + cache.listeners.size > 0\n  })\n"],"names":["getRootCause","cause","isSameCtx","ctx1","ctx2","addOnConnect","anAtom","cb","__reatom","connectHooks","Set","add","addOnDisconnect","disconnectHooks","addOnUpdate","updateHooks","onConnect","connectHook","ctx","controller","AbortController","cleanup","merge","get","read","isConnected","Promise","catch","error","isAbort","cleanupHook","_ctx","delete","has","abort","toAbortError","name","onUpdate","noop","deps","reduce","acc","dep","un","hook","patch","state","isAction","length","call","at","payload","params","hooks","_onUpdate","_ref","proto","cache","subs","size","listeners","initState","isActiveAtom","atom","Object","assign","toggleConnection","action","value","spy","onDisconnect","spyChange","handler","isChanged","newState","prevState","createState","throwReatomError"],"mappings":"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"}