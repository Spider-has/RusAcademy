var React=require("react"),shim=require("use-sync-external-store/shim"),core=require("@reatom/core"),lens=require("@reatom/lens");function _interopDefaultLegacy(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var React__default=/*#__PURE__*/_interopDefaultLegacy(React);let getName=type=>{let name=React__default.default.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED?.ReactCurrentOwner?.current?.type?.name;return name&&name.concat(".",type)||`_${type}`},batch=cb=>cb();const reatomContext=React__default.default.createContext(null),useCtx=()=>{let ctx=React__default.default.useContext(reatomContext);return core.throwReatomError(!ctx,"ctx is not set, you probably forgot to specify the ctx provider"),ctx};let bindBind=(ctx,fn)=>lens.bind(ctx,fn);const useRefSetup=(deps,setup)=>{let ref=React__default.default.useRef();return(void 0===ref.current||ref.current.deps.length!==deps.length||ref.current.deps.some((v,i)=>!Object.is(v,deps[i])))&&(ref.current=setup()),ref},useAtom=function(anAtom,userDeps,options){void 0===userDeps&&(userDeps=[]),void 0===options&&(options={});let{name:name,subscribe:subscribe=!0}="boolean"==typeof options?{subscribe:options}:options,ctx=useCtx(),deps=[ctx];core.isAtom(anAtom)&&deps.push(anAtom);let{theAtom:theAtom,depsAtom:depsAtom,update:update,sub:sub,get:get}=useRefSetup(deps,()=>{let atomName=getName(name??"useAtom#"+typeof anAtom),depsAtom=core.atom([],`${atomName}._depsAtom`),theAtom=anAtom;core.isAtom(theAtom)||(theAtom=core.atom("function"==typeof anAtom?(ctx,state)=>(ctx.spy(depsAtom),anAtom(ctx,state)):anAtom,atomName));let update="function"==typeof theAtom?function(){return batch(()=>theAtom(ctx,...[].slice.call(arguments)))}:void 0;return{theAtom:theAtom,depsAtom:depsAtom,update:update,deps:deps,sub:cb=>ctx.subscribe(theAtom,cb),get:()=>ctx.get(theAtom),subscribe:subscribe}}).current;return ctx.get(()=>{if(!core.isAtom(anAtom)){const prevDeps=ctx.get(depsAtom);(userDeps.length!==prevDeps.length||userDeps.some((dep,i)=>!Object.is(dep,prevDeps[i])))&&("function"==typeof anAtom?depsAtom(ctx,userDeps):update(ctx,anAtom))}return[subscribe?shim.useSyncExternalStore(sub,get,get):get(),update,theAtom,ctx]})};exports.reatomContext=reatomContext,exports.setupBatch=newBatch=>{batch=newBatch},exports.useAction=function(fn,deps,name){void 0===deps&&(deps=[]),deps??=[];let ctx=useCtx();deps.push(ctx),core.isAction(fn)&&deps.push(fn);let ref=useRefSetup(deps,()=>{let theAction=core.isAction(fn)?fn:core.action(function(){return ref.current.fn(...[].slice.call(arguments))},name??getName("useAction"));return{fn:fn,deps:deps,cb:function(){return batch(()=>theAction(ctx,...[].slice.call(arguments)))}}});return React__default.default.useLayoutEffect(()=>{ref.current.fn=fn}),ref.current.cb},exports.useAtom=useAtom,exports.useAtomCreator=function(creator,deps,options){void 0===deps&&(deps=[]);const ref=useRefSetup(deps,()=>({deps:deps,theAtom:creator()}));return useAtom(ref.current.theAtom,[],options)},exports.useCreateCtx=extension=>{const ctxRef=React__default.default.useRef(null);return ctxRef.current||(ctxRef.current=core.createCtx(),extension?.(ctxRef.current)),ctxRef.current},exports.useCtx=useCtx,exports.useCtxBind=()=>lens.bind(useCtx(),bindBind),exports.useUpdate=(cb,deps)=>{const ctx=useCtx();return React__default.default.useEffect(()=>{const call=ctx=>{cb(ctx,...deps.map(thing=>core.isAtom(thing)?ctx.get(thing):thing))};return call(ctx),deps.forEach((thing,i)=>core.isAtom(thing)&&(thing.__reatom.updateHooks??=new Set).add(call)),()=>deps.forEach((thing,i)=>core.isAtom(thing)&&thing.__reatom.updateHooks.delete(call))},deps.concat(ctx)),null},exports.withBatching=ctx=>{let queue=[];return{...ctx,subscribe:(anAtom,cb)=>ctx.subscribe(anAtom,cb&&(value=>Promise.resolve(queue.push(()=>cb(value))).then(length=>length===queue.length&&batch(()=>queue.splice(0).forEach(cb=>cb())))))}};
//# sourceMappingURL=index.js.map
