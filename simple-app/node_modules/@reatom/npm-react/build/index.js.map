{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["import React from 'react'\nimport { useSyncExternalStore } from 'use-sync-external-store/shim'\nimport {\n  action,\n  Action,\n  atom,\n  Atom,\n  AtomMut,\n  AtomState,\n  createCtx,\n  Ctx,\n  CtxSpy,\n  Fn,\n  isAction,\n  isAtom,\n  throwReatomError,\n} from '@reatom/core'\nimport { bind, Binded } from '@reatom/lens'\n\nlet getName = (type: string): string => {\n  let name =\n    // @ts-expect-error do we have another way?\n    React.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED?.ReactCurrentOwner\n      ?.current?.type?.name\n  return (name && name.concat('.', type)) || `_${type}`\n}\n\nlet batch = (cb: Fn) => cb()\n\nexport const setupBatch = (newBatch: typeof batch) => {\n  batch = newBatch\n}\n\nexport const withBatching = (ctx: Ctx): Ctx => {\n  let queue: Array<Fn> = []\n  return {\n    ...ctx,\n    // @ts-ignore\n    subscribe: (anAtom, cb) =>\n      ctx.subscribe(\n        anAtom,\n        cb &&\n          ((value) =>\n            Promise.resolve(queue.push(() => cb(value))).then(\n              (length) =>\n                length === queue.length &&\n                batch(() => queue.splice(0).forEach((cb) => cb())),\n            )),\n      ),\n  }\n}\n\nexport const reatomContext = React.createContext<null | Ctx>(null)\n\nexport const useCtx = (): Ctx => {\n  let ctx = React.useContext(reatomContext)\n\n  throwReatomError(\n    !ctx,\n    'ctx is not set, you probably forgot to specify the ctx provider',\n  )\n\n  return ctx!\n}\n\nlet bindBind = (ctx: Ctx, fn: Fn) => bind(ctx, fn)\nexport const useCtxBind = (): (<T extends Fn>(fn: T) => Binded<T>) =>\n  bind(useCtx(), bindBind)\n\n// use it instead of `setState` to handle HMR\nconst useRefSetup = <T extends Fn<[], { deps: Array<any> }>>(\n  deps: Array<any>,\n  setup: T,\n): React.MutableRefObject<ReturnType<T>> => {\n  let ref = React.useRef<ReturnType<typeof setup>>()\n  if (\n    ref.current === undefined ||\n    ref.current.deps.length !== deps.length ||\n    ref.current!.deps.some((v, i) => !Object.is(v, deps[i]!))\n  ) {\n    // @ts-expect-error\n    ref.current = setup()\n  }\n\n  // @ts-expect-error\n  return ref\n}\n\n// @ts-ignore\nexport const useAtom: {\n  <T extends Atom>(\n    atom: T,\n    deps?: Array<any>,\n    options?: boolean | { name?: string; subscribe?: boolean },\n  ): [\n    AtomState<T>,\n    T extends Fn<[Ctx, ...infer Args], infer Res> ? Fn<Args, Res> : undefined,\n    T,\n    Ctx,\n  ]\n  <T>(\n    init: T | Fn<[CtxSpy], T>,\n    deps?: Array<any>,\n    options?: boolean | { name?: string; subscribe?: boolean },\n  ): [T, Fn<[T | Fn<[T, Ctx], T>], T>, AtomMut<T>, Ctx]\n} = (\n  anAtom: any,\n  userDeps: Array<any> = [],\n  options: boolean | { name?: string; subscribe?: boolean } = {},\n) => {\n  let { name, subscribe = true }: { name?: string; subscribe?: boolean } =\n    typeof options === 'boolean' ? { subscribe: options } : options\n  let ctx = useCtx()\n  let deps: any[] = [ctx]\n  if (isAtom(anAtom)) deps.push(anAtom)\n\n  let { theAtom, depsAtom, update, sub, get } = useRefSetup(deps, () => {\n    let atomName = getName(name ?? `useAtom#${typeof anAtom}`)\n    let depsAtom = atom<any[]>([], `${atomName}._depsAtom`)\n    let theAtom = anAtom\n    if (!isAtom(theAtom)) {\n      theAtom = atom(\n        typeof anAtom === 'function'\n          ? (ctx: CtxSpy, state?: any) => {\n              ctx.spy(depsAtom)\n              return anAtom(ctx, state)\n            }\n          : anAtom,\n        atomName,\n      )\n    }\n    let update =\n      typeof theAtom === 'function'\n        ? // @ts-expect-error\n          (...a) => batch(() => theAtom(ctx, ...a))\n        : undefined\n    let sub = (cb: Fn) => ctx.subscribe(theAtom, cb)\n    let get = () => ctx.get(theAtom)\n\n    return { theAtom, depsAtom, update, deps, sub, get, subscribe }\n  }).current\n\n  return ctx.get(() => {\n    if (!isAtom(anAtom)) {\n      const prevDeps = ctx.get(depsAtom)\n      if (\n        userDeps.length !== prevDeps.length ||\n        userDeps.some((dep, i) => !Object.is(dep, prevDeps[i]))\n      ) {\n        if (typeof anAtom === 'function') depsAtom(ctx, userDeps)\n        else update!(ctx, anAtom)\n      }\n    }\n\n    return [\n      subscribe ? useSyncExternalStore(sub, get, get) : get(),\n      update,\n      theAtom,\n      ctx,\n    ]\n  })\n}\n\nexport const useAtomCreator = <T extends Atom>(\n  creator: Fn<[], T>,\n  deps: Array<any> = [],\n  options?: { subscribe?: boolean },\n) => {\n  const ref = useRefSetup(deps, () => ({ deps, theAtom: creator() }))\n  return useAtom(ref.current.theAtom, [], options)\n}\n\nexport const useUpdate = <T extends [any] | Array<any>>(\n  cb: Fn<\n    [\n      Ctx,\n      ...{\n        [K in keyof T]: T[K] extends Atom ? AtomState<T[K]> : T[K]\n      },\n    ]\n  >,\n  deps: T,\n): null => {\n  const ctx = useCtx()\n\n  React.useEffect(() => {\n    const call = (ctx: Ctx) => {\n      // @ts-expect-error\n      cb(ctx, ...deps.map((thing) => (isAtom(thing) ? ctx.get(thing) : thing)))\n    }\n\n    call(ctx)\n\n    deps.forEach(\n      (thing, i) =>\n        isAtom(thing) && (thing.__reatom.updateHooks ??= new Set()).add(call),\n    )\n\n    return () =>\n      deps.forEach(\n        (thing, i) => isAtom(thing) && thing.__reatom.updateHooks!.delete(call),\n      )\n  }, deps.concat(ctx))\n\n  return null\n}\n\nexport const useAction = <T extends Fn<[Ctx, ...Array<any>]>>(\n  fn: T,\n  deps: Array<any> = [],\n  name?: string,\n): T extends Fn<[Ctx, ...infer Args], infer Res> ? Fn<Args, Res> : never => {\n  deps ??= []\n  let ctx = useCtx()\n  deps.push(ctx)\n  if (isAction(fn)) deps.push(fn)\n\n  let ref = useRefSetup(deps, () => {\n    let theAction: Action = isAction(fn)\n      ? fn\n      : action((...a) => ref.current!.fn(...a), name ?? getName(`useAction`))\n    let cb = (...a: Array<any>) => batch(() => theAction(ctx, ...a))\n    return { fn, deps, cb }\n  })\n  React.useLayoutEffect(() => {\n    ref.current!.fn = fn\n  })\n\n  // @ts-ignore\n  return ref.current.cb\n}\n\nexport const useCreateCtx = (extension?: Fn<[Ctx]>) => {\n  const ctxRef = React.useRef(null as null | Ctx)\n  if (!ctxRef.current) {\n    ctxRef.current = createCtx()\n    extension?.(ctxRef.current)\n  }\n  return ctxRef.current\n}\n\n// export let unstable_reatomComponent =\n//   <T = {}>(\n//     render: (\n//       ctx: CtxSpy,\n//       props: React.PropsWithChildren<T>,\n//     ) => React.ReactElement,\n//   ): React.FC<T> =>\n//   (props) => {\n//     let ctx = useCtx()\n//     return ctx.get(() => {\n//       let trackCtx: Ctx = {\n//         get: ctx.get,\n//         spy(anAtom) {},\n//         schedule: ctx.schedule,\n//         subscribe: ctx.subscribe,\n//         cause: ctx.cause,\n//       }\n//       let element = render(trackCtx, props)\n//     })\n\n//     let [propsAtom] = useState(() => atom(props))\n//     propsAtom(useCtx(), props)\n//     let [[element]] = useAtom((ctx, state?: any) => {\n//       let props = ctx.spy(propsAtom)\n\n//       return [\n//         props === ctx.cause!.parents[0]?.state ? state : render(ctx, props),\n//       ]\n//     })\n\n//     return element\n//   }\n"],"names":["getName","type","name","React","__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED","ReactCurrentOwner","current","concat","batch","cb","reatomContext","createContext","useCtx","ctx","useContext","throwReatomError","bindBind","fn","bind","useRefSetup","deps","setup","ref","useRef","undefined","length","some","v","i","Object","is","useAtom","anAtom","userDeps","options","subscribe","isAtom","push","theAtom","depsAtom","update","sub","get","atomName","atom","state","spy","slice","call","arguments","prevDeps","dep","useSyncExternalStore","newBatch","isAction","theAction","action","useLayoutEffect","creator","extension","ctxRef","createCtx","useCtxBind","useUpdate","useEffect","map","thing","forEach","__reatom","updateHooks","Set","add","delete","queue","value","Promise","resolve","then","splice"],"mappings":"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"}